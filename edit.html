<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Quản lý dữ liệu</title>
        <script src="https://unpkg.com/@barba/core"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Thư viện Noti đẹp -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <style>
            body { font-family: 'Roboto', sans-serif; text-align: center; padding: 20px; background: #f5f5f5; }
            .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1); }
            table { width: 100%; margin-top: 20px; }
            th, td { padding: 10px; text-align: -webkit-match-parent; text-align: match-parent; }
            .title { font-size: 2rem; font-weight: bold; color: #4096ec; text-transform: uppercase; margin-bottom: 20px; }
            .striped tbody tr:nth-child(odd) { background-color: #e3f2fd; }

            /* Chặn thao tác ban đầu */
            body.loading {
                pointer-events: none; /* Chặn click, nhập liệu */
                opacity: 0.5; /* Làm mờ trang để báo hiệu đang tải */
            }

            /* Thiết kế spinner */
            .loading-spinner {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Hiệu ứng cho chữ "Đang load dữ liệu" */
            .loading-text {
                position: fixed;
                top: 50%;
                left: 51%;
                transform: translate(-50%, 50px); /* Đặt chữ bên dưới spinner */
                font-size: 18px;
                font-weight: bold;
                color: #3498db;
                animation: bounce 1.5s infinite;
            }

            /* Hiệu ứng cho chữ bouncinh (nhún lên xuống) */
            @keyframes bounce {
                0%, 100% {
                    transform: translate(-50%, 50px); /* Vị trí ban đầu */
                }
                50% {
                    transform: translate(-50%, 60px); /* Chữ nhún lên một chút */
                }
            }  
        </style>
    </head>

    <body data-barba="wrapper">

        <!-- <div id="loadingSpinner" class="loading-spinner"></div>
        <div id="loadingText" class="loading-text">Đang load dữ liệu...</div> -->
    
        <div class="container">
            <h4 class="title">Tìm kiếm thông tin nhân viên cần sửa</h4>
            <div class="input-field">
                <input type="text" id="searchInput">
                <label for="searchInput">Nhập ID hoặc tên cần tìm</label>
            </div>
            <button class="btn orange waves-effect waves-light" onclick="fetchEditData()">Tìm thông tin</button>

            <h4 class="title">Chỉnh sửa thông tin</h4>
<!-- Thông tin cá nhân cơ bản -->
<div class="row">
    <div class="input-field col s2">
        <input type="text" id="ID" readonly>
        <label for=ID">ID</label>
    </div>
    <div class="input-field col s5">
        <input type="text" id="name" oninput="this.value = this.value.replace(/[^a-zA-ZÀ-ỹ\s]/g, '')">
        <label for="name">Họ và tên</label> 
    </div>
    <div class="input-field col s5">
        <input type="text" id="jobtitle" oninput="this.value = this.value.replace(/[^a-zA-ZÀ-ỹ\s]/g, '')">
        <label for="jobtitle">Chức danh nghề nghiệp</label>
    </div>
</div>
<div class="row">
    <div class="input-field col s6">
        <input type="number" id="age" oninput="this.value = this.value.slice(0, 4);" 
        onblur="if (this.value.length < 4 || (this.value.length === 4 && (this.value < 1900 || this.value > 2099))) { 
            Swal.fire('Lỗi', 'Năm sinh không hợp lệ. Vui lòng kiểm tra lại.', 'error'); 
        }">
        <label for="age">Năm sinh</label>
    </div>
    <div class="input-field col s6">
        <input type="number" id="phone" oninput="this.value = this.value.slice(0, 10);" 
        onblur="if (this.value.length < 10 || this.value.length > 11) {
            Swal.fire('Lỗi', 'Vui lòng kiểm tra lại số điện thoại có đúng không', 'error');
        }">
        <label for="phone">Số điện thoại</label>
    </div>
</div>
<!-- Chỉ số sức khỏe (Chiều cao) (Cân nặng) (BMI) -->
<div class="row">
    <div class="input-field col s4 custom-height">
        <input type="text" id="height" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="flex-input">
        <label for="height">Chiều cao</label>
        <span class="unit-label">cm</span>
    </div>
    <style>
        .custom-height{
            display: flex; 
            align-items: center;
        }
    </style>
    <div class="input-field col s4 custom-wweight">
        <input type="text" id="weight" oninput="this.value = this.value.replace(/[^0-9]/g, ''); calculateBMI();">
        <label for="weight">Cân nặng</label>
        <span class="unit-label">kg</span>
    </div>
    <style>
        .custom-wweight{
            display: flex; 
            align-items: center;
        }
    </style>
    <div class="input-field col s4">
        <input type="text" id="bmi" readonly>
        <label for="bmi">BMI</label>
    </div>
</div>
<!-- Chỉ số xét nghiệm (Huyết Áp) (Glucose) (Ure) (Creatinin) -->
<div class="row">
    <div class="input-field col s12 custom-bloodpressure">
        <input type="text" id="bloodpressure" oninput="this.value = this.value.replace(/[^0-9/]/g, '').replace(/(\/.*\/)/g, '/');" pattern="^\d{1,3}\/\d{1,3}$">
        <label for="bloodpressure">Huyết áp</label>
        <span class="unit-label">mmHg</span>
    </div>
</div>
<style>
    .custom-bloodpressure{
        display: flex; 
        align-items: center;
    }
</style>
<div class="row">
    <div class="input-field col s4 align-center">
        <input type="text" id="whitebloodcell" 
            oninput="this.value = this.value.replace(/[^0-9,.]/g, '').replace(/(,.*?,)/g, ',');" 
            onblur="
                if (this.value.includes('.')) {
                    this.value = this.value.replace('.', ',');
                } else if (this.value && !this.value.includes(',')) { 
                    this.value += ',0'; 
                } else if (this.value.endsWith(',')) { 
                    this.value += '0'; 
                }">
        <label for="whitebloodcell">Bạch Cầu</label>
    </div>
    <div class="input-field col s4 align-center">
        <input type="text" id="redbloodcell" 
                oninput="this.value = this.value.replace(/[^0-9,.]/g, '').replace(/(,.*?,)/g, ',');" 
                onblur="
                if (this.value.includes('.')) {
                    this.value = this.value.replace('.', ',');
                } else if (this.value && !this.value.includes(',')) { 
                    this.value += ',0'; 
                } else if (this.value.endsWith(',')) { 
                    this.value += '0'; 
                }">
        <label for="redbloodcell">Hồng Cầu</label>
    </div>
    <div class="input-field col s4 align-center">
        <input type="number" id="platelet">
        <label for="platelet">Tiểu Cầu</label>
    </div>
</div>
<div class="row">
    <div class="input-field col s4 align-center">
        <input type="text" id="Glucose" 
            oninput="this.value = this.value.replace(/[^0-9,.]/g, '').replace(/(,.*?,)/g, ',');" 
            onblur="
                if (this.value.includes('.')) {
                    this.value = this.value.replace('.', ',');
                } else if (this.value && !this.value.includes(',')) { 
                    this.value += ',0'; 
                } else if (this.value.endsWith(',')) { 
                    this.value += '0'; 
                }">
        <label for="Glucose">Glucose</label>
    </div>
    <div class="input-field col s4 align-center">
        <input type="text" id="Ure" 
            oninput="this.value = this.value.replace(/[^0-9,.]/g, '').replace(/(,.*?,)/g, ',');" 
            onblur="
                if (this.value.includes('.')) {
                    this.value = this.value.replace('.', ',');
                } else if (this.value && !this.value.includes(',')) { 
                    this.value += ',0'; 
                } else if (this.value.endsWith(',')) { 
                    this.value += '0'; 
                }">
        <label for="Ure">Ure</label>
    </div>
    <div class="input-field col s4 align-center">
        <input type="text" id="Creatinin" 
            oninput="this.value = this.value.replace(/[^0-9,.]/g, '').replace(/(,.*?,)/g, ',');" 
            onblur="
                if (this.value.includes('.')) {
                    this.value = this.value.replace('.', ',');
                } else if (this.value && !this.value.includes(',')) { 
                    this.value += ',0'; 
                } else if (this.value.endsWith(',')) { 
                    this.value += '0'; 
                }">
        <label for="Creatinin">Creatinin</label>
    </div>
</div>
<div class="row">
    <div class="input-field col s6 align-center">
        <input type="text" id="SGOT" 
            oninput="this.value = this.value.replace(/[^0-9,.]/g, '').replace(/(,.*?,)/g, ',');" 
            onblur="
                if (this.value.includes('.')) {
                    this.value = this.value.replace('.', ',');
                } else if (this.value && !this.value.includes(',')) { 
                    this.value += ',0'; 
                } else if (this.value.endsWith(',')) { 
                    this.value += '0'; 
                }">
        <label for="SGOT">SGOT (AST)</label>
    </div>
    <div class="input-field col s6 align-center">
        <input type="text" id="SGPT" 
            oninput="this.value = this.value.replace(/[^0-9,.]/g, '').replace(/(,.*?,)/g, ',');" 
            onblur="
                if (this.value.includes('.')) {
                    this.value = this.value.replace('.', ',');
                } else if (this.value && !this.value.includes(',')) { 
                    this.value += ',0'; 
                } else if (this.value.endsWith(',')) { 
                    this.value += '0'; 
                }">
        <label for="SGPT">SGPT (ALT)</label>
    </div>
</div>

            <button class="btn green waves-effect waves-light" onclick="updateData()">Cập nhật</button>
    
        </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbz_eGXI1hGmeHjtElHxPXzciawj1a9DQkWNL3spjJXr5EDbmTRMm8TQvpnyk2-59vFn/exec";

// Hàm tính năng chính

        function fetchEditData() {
            // document.body.classList.add("loading"); // Khóa thao tác
            showLoading(); // Hiện spinner và chữ "Đang load dữ liệu"
            let query = document.getElementById("searchInput").value.trim();
            if (!query) {
                Swal.fire("Lỗi", "Vui lòng nhập ID hoặc tên để tìm kiếm.", "error");
                return;
            }
            let url = `${scriptURL}?action=searchuser&query=${encodeURIComponent(query)}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    Swal.fire("Thông báo", "Không tìm thấy dữ liệu.", "info");
                    clearInputs(["searchInput"]);
                    M.updateTextFields();
                    hideLoading(); // Ẩn spinner và chữ "Đang load dữ liệu"
                    return;
                }
                
                let userData = data[0];
                document.getElementById("ID").value = userData[0];
                document.getElementById("name").value = userData[1];
                document.getElementById("jobtitle").value = userData[2]
                document.getElementById("age").value = userData[3];
                document.getElementById("phone").value = userData[4];
                document.getElementById("height").value = userData[5];
                document.getElementById("weight").value = userData[6];
                document.getElementById("bmi").value = userData[7];;
                document.getElementById("bloodpressure").value = userData[8];
                document.getElementById("whitebloodcell").value = userData[9];
                document.getElementById("redbloodcell").value = userData[10];
                document.getElementById("platelet").value = userData[11];
                document.getElementById("Glucose").value = userData[12];
                document.getElementById("Ure").value = userData[13];
                document.getElementById("Creatinin").value = userData[14];
                document.getElementById("SGOT").value = userData[15];
                document.getElementById("SGPT").value = userData[16];
                clearInputs(["searchInput"]);
                M.updateTextFields(); // Cập nhật giao diện Materialize
                hideLoading(); // Ẩn spinner và chữ "Đang load dữ liệu"
            })
            .catch(error => {
                console.error("Lỗi:", error);
                Swal.fire("Lỗi", "Đã xảy ra lỗi khi tìm kiếm.", "error");
                hideLoading(); // Ẩn spinner và chữ "Đang load dữ liệu"
            });
        }
    
    function updateData() {
        let editID = document.getElementById("ID").value.trim();
        let name = document.getElementById("name").value.trim();
        let jobtitle = document.getElementById("jobtitle").value.trim();
        let age = document.getElementById("age").value.trim();
        let phone = document.getElementById("phone").value.trim();
        let height = document.getElementById("height").value.trim();
        let weight = document.getElementById("weight").value.trim();
        let bmi = document.getElementById("bmi").value.trim();
        let bloodpressure = document.getElementById("bloodpressure").value.trim();
        let whitebloodcell = document.getElementById("whitebloodcell").value.trim();
        let redbloodcell = document.getElementById("redbloodcell").value.trim();
        let platelet = document.getElementById("platelet").value.trim();
        let Glucose = document.getElementById("Glucose").value.trim();
        let Ure = document.getElementById("Ure").value.trim();
        let Creatinin = document.getElementById("Creatinin").value.trim();
        let SGOT = document.getElementById("SGOT").value.trim();
        let SGPT = document.getElementById("SGPT").value.trim();
        
        if (!name.trim() || !jobtitle.trim() || !age.trim() || !phone.trim() || !height.trim() || !weight.trim() || !bmi.trim()
            || !bloodpressure.trim() || !whitebloodcell.trim() || !redbloodcell.trim() || !platelet.trim() 
            || !Glucose.trim() || !Ure.trim() || !Creatinin.trim() || !SGOT.trim() || !SGPT.trim()) {
            Swal.fire("Lỗi", "Vui lòng nhập đầy đủ thông tin.", "error");
            return;
        }
        
        let url = `${scriptURL}?action=updateuser` +
                  `&id=${encodeURIComponent(editID)}` +
                  `&name=${encodeURIComponent(name)}` +
                  `&jobtitle=${encodeURIComponent(jobtitle)}` +
                  `&age=${encodeURIComponent(age)}` +
                  `&phone=${encodeURIComponent(phone)}` +
                  `&height=${encodeURIComponent(height)}` +
                  `&weight=${encodeURIComponent(weight)}` +
                  `&bmi=${encodeURIComponent(bmi)}` +
                  `&bloodpressure=${encodeURIComponent(bloodpressure)}` +
                  `&whitebloodcell=${encodeURIComponent(whitebloodcell)}` +
                  `&redbloodcell=${encodeURIComponent(redbloodcell)}` +
                  `&platelet=${encodeURIComponent(platelet)}` +
                  `&Glucose=${encodeURIComponent(Glucose)}` +
                  `&Ure=${encodeURIComponent(Ure)}` +
                  `&Creatinin=${encodeURIComponent(Creatinin)}` +
                  `&SGOT=${encodeURIComponent(SGOT)}` +
                  `&SGPT=${encodeURIComponent(SGPT)}`;
        
        fetch(url)
            .then(response => response.text())
            .then(data => {
                Swal.fire("Thành công", data, "success");
                clearInputs([ "ID", "name", "jobtitle", "age", "phone", "height", "weight", "bmi", 
                              "bloodpressure", "whitebloodcell", "redbloodcell", "platelet", 
                              "Glucose", "Ure", "Creatinin", "SGOT", "SGPT"]);
                M.updateTextFields(); // Cập nhật giao diện Materialize
            })
            .catch(error => console.error("Lỗi:", error));
        }

// Hàm support giao diện

        // Hàm để thêm spinner và chữ "Đang load dữ liệu" vào trang
        function showLoading() {
            // Tạo phần tử spinner
            const spinner = document.createElement("div");
            spinner.id = "loadingSpinner";
            spinner.classList.add("loading-spinner");
            
            // Tạo phần tử chữ "Đang load dữ liệu"
            const loadingText = document.createElement("div");
            loadingText.id = "loadingText";
            loadingText.classList.add("loading-text");
            loadingText.textContent = "Đang load dữ liệu...";

            // Thêm phần tử spinner và chữ vào body
            document.body.appendChild(spinner);
            document.body.appendChild(loadingText);
            
            // Thêm lớp loading vào body để khóa các thao tác
            document.body.classList.add("loading");
        }

        // Hàm để xóa spinner và chữ "Đang load dữ liệu"
        function hideLoading() {
            // Xóa phần tử spinner và chữ "Đang load dữ liệu" khỏi DOM
            const spinner = document.getElementById("loadingSpinner");
            const loadingText = document.getElementById("loadingText");

            if (spinner) {
                spinner.remove();
            }
            if (loadingText) {
                loadingText.remove();
            }
            
            // Xóa lớp loading khỏi body để cho phép thao tác
            document.body.classList.remove("loading");
        }

// Hàm support tính năng

        function clearInputs(inputs) {
            inputs.forEach(id => document.getElementById(id).value = "");
        }

        function calculateBMI() {
            const height = parseFloat(document.getElementById("height").value) / 100; // Convert cm to meters
            const weight = parseFloat(document.getElementById("weight").value);
            if (height > 0 && weight > 0) {
                const bmi = (weight / (height * height)).toFixed(2);
                document.getElementById("bmi").value = bmi;
            } else {
                document.getElementById("bmi").value = "";
            }
        }
        document.getElementById("height").addEventListener("input", calculateBMI);
    </script>
</body>
</html>
